<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gift Watch</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --primary: #38bdf8;
      --border: #1e293b;
      --text: #e2e8f0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", "SF Pro", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(94, 234, 212, 0.08), transparent 25%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 18px 48px;
    }

    h1, h2, h3 {
      margin: 0 0 8px;
      letter-spacing: 0.01em;
    }

    p { margin: 0; }

    .page { max-width: 1280px; margin: 0 auto; }

    .hero { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }

    .hero-title {
      font-size: 32px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      color: #67e8f9;
      font-size: 12px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
    }

    .top-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 16px; margin-bottom: 16px; }

    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    .metric-card {
      margin-bottom: 16px;
      border: 1px solid rgba(56, 189, 248, 0.35);
    }

    .metric-value {
      font-size: 36px;
      font-weight: 800;
      margin-top: 8px;
      color: #67e8f9;
      letter-spacing: 0.02em;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    label { font-weight: 600; }

    input, button, select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1324;
      color: var(--text);
      font-size: 14px;
    }

    input:focus, button:focus, select:focus {
      outline: 2px solid rgba(56, 189, 248, 0.5);
      outline-offset: 1px;
    }

    button {
      background: linear-gradient(135deg, #22d3ee, #0ea5e9);
      border: none;
      color: #0b1220;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(14, 165, 233, 0.35); }

    .table-scroll { overflow-x: auto; margin-top: 8px; }

    table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-top: 0; font-size: 14px; min-width: 500px; }

    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; white-space: normal; word-break: break-word; }

    th { color: #cbd5e1; font-size: 13px; text-transform: uppercase; letter-spacing: 0.04em; }
    tbody tr:nth-child(odd) td { background: rgba(255, 255, 255, 0.02); }

    .number { font-variant-numeric: tabular-nums; white-space: nowrap; }
    .muted { color: var(--muted); }
    .flex-between { display: flex; justify-content: space-between; gap: 12px; align-items: center; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: #e2e8f0;
      font-size: 12px;
    }

    .empty { color: var(--muted); font-style: italic; margin-top: 6px; }

    .view-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 120ms ease, background 120ms ease;
    }

    .toggle-btn.active { border-color: var(--primary); background: rgba(56, 189, 248, 0.12); color: #67e8f9; }

    .view { display: none; }
    .view.active { display: block; }

    .mobile-layout .row,
    .tablet-layout .row {
      width: 100%;
      gap: 8px;
    }

    .mobile-layout input,
    .mobile-layout button,
    .mobile-layout select {
      width: 100%;
    }

    .tablet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }

    @media (max-width: 768px) {
      .hero-title { font-size: 24px; }
      .top-grid { grid-template-columns: 1fr; }
      .page { padding: 0 4px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div>
        <div class="hero-title">Gift Watch <span class="pill">实时礼物监控</span></div>
        <p class="hint">桌面版保留全部功能，手机 / 平板版仅保留搜索与全部清单，方便触摸操作。金额已按电池价值折算（1 电池=¥0.1）。</p>
      </div>
      <div class="view-toggle" aria-label="界面切换">
        <button class="toggle-btn active" data-view-target="desktop">桌面版</button>
        <button class="toggle-btn" data-view-target="mobile">手机专用</button>
        <button class="toggle-btn" data-view-target="tablet">平板专用</button>
      </div>
    </div>

    <div class="card metric-card">
      <div class="flex-between" style="gap:8px; align-items: flex-end;">
        <div>
          <h2 style="margin-bottom:4px;">总流水</h2>
          <p class="hint">基于当前加载的“最新礼物流水”列表实时计算，单位为元。</p>
        </div>
        <div class="badge" id="totalFlowMeta">记录：- ｜ 数量：-</div>
      </div>
      <div class="metric-value" id="totalFlowValue">-</div>
    </div>

    <!-- 桌面版：原有布局，包含房间礼物清单 -->
    <div id="view-desktop" class="view active">
      <div class="top-grid">
        <div class="card">
          <div class="section-header">
            <h2>用户礼物查询</h2>
            <span class="muted">支持按用户、礼物过滤并自动汇总</span>
          </div>
          <div class="row">
            <input id="uname-desktop" placeholder="用户名（精确匹配）" />
            <input id="gift-desktop" placeholder="礼物名（可选）" />
            <input id="startTime-desktop" type="datetime-local" aria-label="开始时间" />
            <input id="limit-desktop" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
            <button id="btnSearch-desktop">搜索</button>
          </div>
          <p class="hint" style="margin-top:8px">会自动合并重复用户/礼物数量，默认从早上 8 点开始查询，截止到点击搜索的当前时间。</p>
          <div id="searchSummary-desktop"></div>
          <div id="searchAggregated-desktop"></div>
          <div id="searchRaw-desktop"></div>
        </div>

        <div class="card">
          <div class="section-header">
            <h2>最新礼物流水</h2>
            <div class="row">
              <input id="allLimit-desktop" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
              <button id="btnLoadAll-desktop">刷新全部</button>
            </div>
          </div>
          <p class="hint">默认展示最新 200 条，可根据需要调整（最多 1000 条）。</p>
          <div id="allOut-desktop"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-header">
          <h2>房间礼物清单</h2>
          <button id="btnLoadRoomGifts">刷新</button>
        </div>
        <p class="hint">直接来自 B 站接口，展示房间内可送出的礼物及其 ID / 价格。</p>
        <div id="roomGiftsOut"></div>
      </div>
    </div>

    <!-- 手机版：仅保留搜索 & 全部清单，单列布局 -->
    <div id="view-mobile" class="view mobile-layout">
      <div class="card" style="margin-bottom:12px;">
        <div class="section-header">
          <h2>快速搜索</h2>
          <span class="muted">为手机触摸优化</span>
        </div>
        <div class="row">
          <input id="uname-mobile" placeholder="用户名（精确匹配）" />
          <input id="gift-mobile" placeholder="礼物名（可选）" />
          <input id="startTime-mobile" type="datetime-local" aria-label="开始时间" />
          <input id="limit-mobile" type="number" min="1" max="500" value="150" aria-label="返回条数" />
          <button id="btnSearch-mobile">搜索</button>
        </div>
        <p class="hint" style="margin-top:8px">默认从今日 8 点开始查询，已为窄屏做压缩展示。</p>
        <div id="searchSummary-mobile"></div>
        <div id="searchAggregated-mobile"></div>
        <div id="searchRaw-mobile"></div>
      </div>

      <div class="card">
        <div class="section-header">
          <h2>全部礼物流水</h2>
          <div class="row">
            <input id="allLimit-mobile" type="number" min="1" max="800" value="150" aria-label="返回条数" />
            <button id="btnLoadAll-mobile">刷新</button>
          </div>
        </div>
        <p class="hint">表格可左右滑动查看全部字段。</p>
        <div id="allOut-mobile"></div>
      </div>
    </div>

    <!-- 平板版：两列布局，无房间礼物清单 -->
    <div id="view-tablet" class="view tablet-layout">
      <div class="tablet-grid">
        <div class="card">
          <div class="section-header">
            <h2>平板搜索</h2>
            <span class="muted">保持信息密度</span>
          </div>
          <div class="row">
            <input id="uname-tablet" placeholder="用户名（精确匹配）" />
            <input id="gift-tablet" placeholder="礼物名（可选）" />
            <input id="startTime-tablet" type="datetime-local" aria-label="开始时间" />
            <input id="limit-tablet" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
            <button id="btnSearch-tablet">搜索</button>
          </div>
          <p class="hint" style="margin-top:8px">保留桌面级的汇总表格，去除房间礼物清单，方便分屏。</p>
          <div id="searchSummary-tablet"></div>
          <div id="searchAggregated-tablet"></div>
          <div id="searchRaw-tablet"></div>
        </div>

        <div class="card">
          <div class="section-header">
            <h2>最新流水</h2>
            <div class="row">
              <input id="allLimit-tablet" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
              <button id="btnLoadAll-tablet">刷新</button>
            </div>
          </div>
          <p class="hint">适配横屏 / 竖屏，支持左右滑动。</p>
          <div id="allOut-tablet"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const fmtTime = (ts) => {
  if (!ts) return "-";
  const d = new Date(ts * 1000);
  return d.toLocaleString();
};

const fmtNumber = (n) => new Intl.NumberFormat("zh-CN").format(n);
const coinsToYuan = (coins) => (Number(coins) || 0) / 1000;
const fmtCurrency = (coins) =>
  new Intl.NumberFormat("zh-CN", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(coinsToYuan(coins));

const defaultStartDate = () => {
  const now = new Date();
  const start = new Date(now);
  start.setHours(8, 0, 0, 0);
  if (start > now) {
    start.setDate(start.getDate() - 1);
  }
  return start;
};

const renderTable = (container, rows, columns, emptyText = "暂无数据") => {
  if (!rows.length) {
    container.innerHTML = `<div class="empty">${emptyText}</div>`;
    return;
  }
  const header = columns.map((c) => `<th>${c.label}</th>`).join("");
  const body = rows
    .map((row) =>
      `<tr>${columns
        .map((c) => `<td class="${c.className || ''}">${c.render ? c.render(row[c.key], row) : row[c.key]}</td>`)
        .join("")}</tr>`
    )
    .join("");
  container.innerHTML = `<div class="table-scroll"><table><thead><tr>${header}</tr></thead><tbody>${body}</tbody></table></div>`;
};

const groupByGift = (records) => {
  const map = new Map();
  records.forEach((r) => {
    const key = r.gift_name || "(未知礼物)";
    const current = map.get(key) || { gift_name: key, total_num: 0, total_price: 0, latest_ts: 0, users: new Set() };
    current.total_num += Number(r.num) || 0;
    current.total_price += Number(r.total_price) || 0;
    current.latest_ts = Math.max(current.latest_ts, r.ts || 0);
    if (r.uname) current.users.add(r.uname);
    map.set(key, current);
  });
  return Array.from(map.values())
    .map((v) => ({ ...v, user_count: v.users.size || 0 }))
    .sort((a, b) => b.total_num - a.total_num || b.latest_ts - a.latest_ts);
};

const groupByUser = (records) => {
  const map = new Map();
  records.forEach((r) => {
    const key = r.uname || `UID-${r.uid}`;
    const current = map.get(key) || { uname: key, total_num: 0, total_price: 0, latest_ts: 0, gifts: new Set() };
    current.total_num += Number(r.num) || 0;
    current.total_price += Number(r.total_price) || 0;
    current.latest_ts = Math.max(current.latest_ts, r.ts || 0);
    if (r.gift_name) current.gifts.add(r.gift_name);
    map.set(key, current);
  });
  return Array.from(map.values())
    .map((v) => ({ ...v, gift_count: v.gifts.size || 0 }))
    .sort((a, b) => b.total_num - a.total_num || b.latest_ts - a.latest_ts);
};

const viewConfigs = {
  desktop: {
    root: document.getElementById("view-desktop"),
    search: {
      button: "btnSearch-desktop",
      inputs: { uname: "uname-desktop", gift: "gift-desktop", start: "startTime-desktop", limit: "limit-desktop" },
      outputs: { summary: "searchSummary-desktop", aggregated: "searchAggregated-desktop", raw: "searchRaw-desktop" },
    },
    latest: { button: "btnLoadAll-desktop", limit: "allLimit-desktop", output: "allOut-desktop" },
    roomGifts: { button: "btnLoadRoomGifts", output: "roomGiftsOut" },
  },
  mobile: {
    root: document.getElementById("view-mobile"),
    search: {
      button: "btnSearch-mobile",
      inputs: { uname: "uname-mobile", gift: "gift-mobile", start: "startTime-mobile", limit: "limit-mobile" },
      outputs: { summary: "searchSummary-mobile", aggregated: "searchAggregated-mobile", raw: "searchRaw-mobile" },
    },
    latest: { button: "btnLoadAll-mobile", limit: "allLimit-mobile", output: "allOut-mobile" },
  },
  tablet: {
    root: document.getElementById("view-tablet"),
    search: {
      button: "btnSearch-tablet",
      inputs: { uname: "uname-tablet", gift: "gift-tablet", start: "startTime-tablet", limit: "limit-tablet" },
      outputs: { summary: "searchSummary-tablet", aggregated: "searchAggregated-tablet", raw: "searchRaw-tablet" },
    },
    latest: { button: "btnLoadAll-tablet", limit: "allLimit-tablet", output: "allOut-tablet" },
  },
};

const viewState = Object.fromEntries(Object.keys(viewConfigs).map((k) => [k, { initialized: false, loadedAll: false, roomLoaded: false }]));

const renderSearch = (records, targets) => {
  const summary = document.getElementById(targets.summary);
  const aggregated = document.getElementById(targets.aggregated);
  const raw = document.getElementById(targets.raw);

  const totalNum = records.reduce((acc, r) => acc + (Number(r.num) || 0), 0);
  const totalPrice = records.reduce((acc, r) => acc + (Number(r.total_price) || 0), 0);
  const latestTs = Math.max(0, ...records.map((r) => r.ts || 0));

  summary.innerHTML = `
    <div class="flex-between" style="margin:12px 0 6px;">
      <div class="badge">记录数：${fmtNumber(records.length)}</div>
      <div class="badge">总数量：${fmtNumber(totalNum)}</div>
      <div class="badge">总金额（元）：${fmtCurrency(totalPrice)}</div>
      <div class="badge">最新时间：${latestTs ? fmtTime(latestTs) : "-"}</div>
    </div>
  `;

  const byGift = groupByGift(records);
  const byUser = groupByUser(records);

  aggregated.innerHTML = `<h3 style="margin-top:8px;">汇总视图</h3>`;
  const giftContainer = document.createElement("div");
  const userContainer = document.createElement("div");
  aggregated.appendChild(giftContainer);
  aggregated.appendChild(userContainer);

  renderTable(
    giftContainer,
    byGift,
    [
      { key: "gift_name", label: "礼物" },
      { key: "total_num", label: "数量合计", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
      { key: "user_count", label: "涉及用户", className: "number", render: (v) => fmtNumber(v) },
      { key: "latest_ts", label: "最新时间", render: (v) => fmtTime(v) },
    ],
    "没有找到相关礼物"
  );

  userContainer.style.marginTop = "12px";
  renderTable(
    userContainer,
    byUser,
    [
      { key: "uname", label: "用户" },
      { key: "total_num", label: "礼物数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "合计金额（元）", className: "number", render: (v) => fmtCurrency(v) },
      { key: "gift_count", label: "礼物种类", className: "number", render: (v) => fmtNumber(v) },
      { key: "latest_ts", label: "最新时间", render: (v) => fmtTime(v) },
    ],
    "没有匹配的用户记录"
  );

  raw.innerHTML = `<h3 style="margin-top:12px;">原始记录</h3>`;
  const rawContainer = document.createElement("div");
  raw.appendChild(rawContainer);
  renderTable(
    rawContainer,
    records,
    [
      { key: "ts", label: "时间", render: (v) => fmtTime(v) },
      { key: "uname", label: "用户" },
      { key: "gift_name", label: "礼物" },
      { key: "num", label: "数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
    ],
    "暂无记录"
  );
};

const getInputValue = (id) => document.getElementById(id)?.value.trim();

const setDefaultStartTime = (id) => {
  const el = document.getElementById(id);
  if (!el) return;
  const start = defaultStartDate();
  el.value = start.toISOString().slice(0, 16);
};

const updateTotalFlow = (records) => {
  const valueEl = document.getElementById("totalFlowValue");
  const metaEl = document.getElementById("totalFlowMeta");
  if (!valueEl || !metaEl) return;

  const totalPrice = records.reduce((acc, r) => acc + (Number(r.total_price) || 0), 0);
  const totalNum = records.reduce((acc, r) => acc + (Number(r.num) || 0), 0);

  valueEl.textContent = `¥${fmtCurrency(totalPrice)}`;
  metaEl.textContent = `记录：${fmtNumber(records.length)} ｜ 数量：${fmtNumber(totalNum)}`;
};

async function search(viewKey) {
  const cfg = viewConfigs[viewKey];
  const inputs = cfg.search.inputs;
  const uname = getInputValue(inputs.uname);
  const gift = getInputValue(inputs.gift);
  const limit = parseInt(document.getElementById(inputs.limit)?.value || "0", 10) || 200;
  const startInput = document.getElementById(inputs.start);
  const startValue = startInput?.value;
  const parsedStart = startValue ? Math.floor(new Date(startValue).getTime() / 1000) : NaN;
  const start_ts = Number.isNaN(parsedStart) ? undefined : parsedStart;

  if (!uname) {
    alert("请输入用户名");
    return;
  }

  const params = new URLSearchParams({ uname, limit: String(limit) });
  if (gift) params.set("gift_name", gift);
  if (start_ts) params.set("start_ts", String(start_ts));

  const resp = await fetch(`/api/search?${params.toString()}`);
  const data = await resp.json();
  renderSearch(data, cfg.search.outputs);
}

async function loadAll(viewKey) {
  const cfg = viewConfigs[viewKey];
  const limitInput = document.getElementById(cfg.latest.limit);
  const limit = parseInt(limitInput?.value || "0", 10) || 200;
  const resp = await fetch(`/api/gifts?limit=${limit}`);
  const data = await resp.json();
  const container = document.getElementById(cfg.latest.output);
  renderTable(
    container,
    data,
    [
      { key: "ts", label: "时间", render: (v) => fmtTime(v) },
      { key: "uname", label: "用户" },
      { key: "gift_name", label: "礼物" },
      { key: "num", label: "数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
    ],
    "暂无礼物流水"
  );
  updateTotalFlow(data);
  viewState[viewKey].loadedAll = true;
}

async function loadRoomGiftList() {
  const out = document.getElementById("roomGiftsOut");
  out.innerHTML = "<div class='muted'>加载中...</div>";
  try {
    const resp = await fetch("/api/room_gift_list");
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    renderTable(
      out,
      data,
      [
        { key: "gift_id", label: "礼物 ID", className: "number" },
        { key: "name", label: "礼物名" },
        { key: "price", label: "价格", className: "number", render: (v) => `${fmtNumber(v)} 金瓜子` },
        { key: "coin_type", label: "币种" },
        { key: "gift_type", label: "类型" },
      ],
      "暂无礼物信息"
    );
    viewState.desktop.roomLoaded = true;
  } catch (err) {
    out.innerHTML = `<div class="empty">加载失败：${err}</div>`;
  }
}

const initView = (viewKey) => {
  const cfg = viewConfigs[viewKey];
  setDefaultStartTime(cfg.search.inputs.start);
  document.getElementById(cfg.search.button)?.addEventListener("click", () => search(viewKey));
  document.getElementById(cfg.latest.button)?.addEventListener("click", () => loadAll(viewKey));
  if (cfg.roomGifts) {
    document.getElementById(cfg.roomGifts.button)?.addEventListener("click", loadRoomGiftList);
  }
  viewState[viewKey].initialized = true;
};

const switchView = (target) => {
  Object.entries(viewConfigs).forEach(([key, cfg]) => {
    cfg.root.classList.toggle("active", key === target);
  });
  document.querySelectorAll(".toggle-btn").forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.viewTarget === target);
  });

  if (!viewState[target].initialized) {
    initView(target);
  }
  if (!viewState[target].loadedAll) {
    loadAll(target);
  }
  if (target === "desktop" && !viewState.desktop.roomLoaded) {
    loadRoomGiftList();
  }
};

document.querySelectorAll("[data-view-target]").forEach((btn) => {
  btn.addEventListener("click", () => switchView(btn.dataset.viewTarget));
});

initView("desktop");
switchView("desktop");
</script>
</body>
</html>
