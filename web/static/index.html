<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gift Watch</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --primary: #38bdf8;
      --border: #1e293b;
      --text: #e2e8f0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", "SF Pro", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(94, 234, 212, 0.08), transparent 25%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 18px 48px;
    }

    h1, h2, h3 {
      margin: 0 0 8px;
      letter-spacing: 0.01em;
    }

    p { margin: 0; }

    .page { max-width: 1280px; margin: 0 auto; }

    .hero { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }

    .hero-left { min-width: 220px; }

    .hero-title {
      font-size: 32px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      color: #67e8f9;
      font-size: 12px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
    }

    .top-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 16px; margin-bottom: 16px; }

    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    .flow-chip {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.08);
      display: grid;
      gap: 4px;
      min-width: 240px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
    }

    .flow-value {
      font-size: 22px;
      font-weight: 800;
      color: #67e8f9;
      letter-spacing: 0.02em;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    label { font-weight: 600; }

    input, button, select, textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1324;
      color: var(--text);
      font-size: 14px;
    }

    input[type="checkbox"],
    input[type="radio"] {
      width: 16px;
      height: 16px;
      padding: 0;
      border-radius: 6px;
      flex-shrink: 0;
      accent-color: #38bdf8;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    input:focus, button:focus, select:focus, textarea:focus {
      outline: 2px solid rgba(56, 189, 248, 0.5);
      outline-offset: 1px;
    }

    button {
      background: linear-gradient(135deg, #22d3ee, #0ea5e9);
      border: none;
      color: #0b1220;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(14, 165, 233, 0.35); }

    .table-scroll { overflow-x: auto; margin-top: 8px; }

    table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-top: 0; font-size: 14px; min-width: 500px; }

    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; white-space: normal; word-break: break-word; }

    th { color: #cbd5e1; font-size: 13px; text-transform: uppercase; letter-spacing: 0.04em; }
    tbody tr:nth-child(odd) td { background: rgba(255, 255, 255, 0.02); }

    .number { font-variant-numeric: tabular-nums; white-space: nowrap; }
    .muted { color: var(--muted); }
    .flex-between { display: flex; justify-content: space-between; gap: 12px; align-items: center; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: #e2e8f0;
      font-size: 12px;
    }

    .empty { color: var(--muted); font-style: italic; margin-top: 6px; }

    .view-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .range-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 120ms ease, background 120ms ease;
    }

    .toggle-btn.active { border-color: var(--primary); background: rgba(56, 189, 248, 0.12); color: #67e8f9; }

    .console-card {
      margin-bottom: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(8, 15, 32, 0.9));
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin: 10px 0 4px;
      align-items: center;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin: 10px 0 6px;
    }

    .settings-block {
      border: 1px dashed var(--border);
      padding: 12px;
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.04);
    }

    .settings-block h4 {
      margin: 0 0 8px;
      font-size: 15px;
    }

    .settings-block label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 13px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    .inline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .settings-block .inline.radios {
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .settings-block .inline {
      align-items: flex-start;
      justify-content: flex-start;
    }

    .settings-block label.inline {
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      font-weight: 600;
      color: #e2e8f0;
      font-size: 14px;
      white-space: nowrap;
      flex-wrap: nowrap;
      text-align: left;
    }

    @media (max-width: 720px) {
      .settings-block .inline.radios {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        flex-wrap: wrap;
      }
    }

    .settings-block .field input,
    .settings-block .field textarea,
    .settings-block .field select {
      width: 100%;
    }

    .muted small {
      color: inherit;
    }

    .filter-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: #cbd5e1;
      font-size: 13px;
    }

    .filter-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .ghost-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
    }

    .console-log {
      background: #0a1020;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      min-height: 110px;
      font-family: "Fira Code", "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 13px;
      color: #e2e8f0;
      overflow: auto;
      white-space: pre-wrap;
    }

    .console-log .line.info { color: #67e8f9; }
    .console-log .line.error { color: #f472b6; }
    .console-log .line.success { color: #34d399; }

    .view { display: none; }
    .view.active { display: block; }

    .mobile-layout .row,
    .tablet-layout .row {
      width: 100%;
      gap: 8px;
    }

    .mobile-layout input,
    .mobile-layout button,
    .mobile-layout select {
      width: 100%;
    }

    .tablet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }

    @media (max-width: 768px) {
      .hero-title { font-size: 24px; }
      .top-grid { grid-template-columns: 1fr; }
      .page { padding: 0 4px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div class="hero-left">
        <div class="hero-title">Gift Watch <span class="pill">实时礼物监控</span></div>
        <div class="range-toggle" aria-label="时间范围切换">
          <button class="toggle-btn active" data-range="today">今日</button>
          <button class="toggle-btn" data-range="week">本周</button>
          <button class="toggle-btn" data-range="month">本月</button>
          <button class="toggle-btn" data-range="all">全部</button>
        </div>
      </div>
      <div class="flow-chip" aria-live="polite" id="guardFlowChip">
        <div class="flex-between" style="gap:10px; align-items:center;">
          <span class="muted" style="font-weight:600;">大航海购买</span>
          <span class="badge" id="guardFlowMeta">舰长：- ｜ 提督：- ｜ 总督：-</span>
        </div>
        <div class="flow-value" id="guardFlowValue">-</div>
      </div>
      <div class="flow-chip" aria-live="polite">
        <div class="flex-between" style="gap:10px; align-items:center;">
          <span class="muted" style="font-weight:600;">总流水</span>
          <span class="badge" id="totalFlowMeta">记录：- ｜ 数量：-</span>
        </div>
        <div class="flow-value" id="totalFlowValue">¥-</div>
      </div>
      <div class="view-toggle" aria-label="界面切换">
        <button class="toggle-btn active" data-view-target="desktop">桌面版</button>
        <button class="toggle-btn" data-view-target="mobile">手机专用</button>
        <button class="toggle-btn" data-view-target="tablet">平板专用</button>
        <button class="toggle-btn" data-view-target="console">控制台</button>
      </div>
    </div>

    <!-- 桌面版：原有布局，包含房间礼物清单 -->
    <div id="view-desktop" class="view active">
      <div class="top-grid">
        <div class="card">
          <div class="section-header">
            <h2>用户礼物查询</h2>
            <span class="muted">支持按用户、礼物过滤并自动汇总</span>
          </div>
          <div class="row">
            <input id="uname-desktop" placeholder="用户名（精确匹配）" />
            <input id="gift-desktop" placeholder="礼物名（可选）" />
            <select id="guardLevel-desktop" aria-label="大航海等级">
              <option value="">全部大航海</option>
              <option value="3">舰长</option>
              <option value="2">提督</option>
              <option value="1">总督</option>
            </select>
            <input id="startTime-desktop" type="datetime-local" aria-label="开始时间" />
            <input id="limit-desktop" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
            <button id="btnSearch-desktop">搜索</button>
          </div>
          <p class="hint" style="margin-top:8px">会自动合并重复用户/礼物数量，默认从早上 8 点开始查询，截止到点击搜索的当前时间。</p>
          <div id="searchSummary-desktop"></div>
          <div id="searchAggregated-desktop"></div>
          <div id="searchRaw-desktop"></div>
        </div>

        <div class="card">
          <div class="section-header">
            <h2>最新礼物流水</h2>
            <div class="row">
              <input id="allLimit-desktop" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
              <button id="btnLoadAll-desktop">刷新全部</button>
            </div>
          </div>
          <p class="hint">默认展示最新 200 条，可根据需要调整（最多 1000 条）。</p>
          <div id="allOut-desktop"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-header">
          <h2>房间礼物清单</h2>
          <button id="btnLoadRoomGifts">刷新</button>
        </div>
        <p class="hint">直接来自 B 站接口，展示房间内可送出的礼物及其 ID / 价格。</p>
        <div id="roomGiftsOut"></div>
      </div>
    </div>

    <!-- 手机版：仅保留搜索 & 全部清单，单列布局 -->
    <div id="view-mobile" class="view mobile-layout">
      <div class="card" style="margin-bottom:12px;">
        <div class="section-header">
          <h2>快速搜索</h2>
          <span class="muted">为手机触摸优化</span>
        </div>
        <div class="row">
          <input id="uname-mobile" placeholder="用户名（精确匹配）" />
          <input id="gift-mobile" placeholder="礼物名（可选）" />
          <select id="guardLevel-mobile" aria-label="大航海等级">
            <option value="">全部大航海</option>
            <option value="3">舰长</option>
            <option value="2">提督</option>
            <option value="1">总督</option>
          </select>
          <input id="startTime-mobile" type="datetime-local" aria-label="开始时间" />
          <input id="limit-mobile" type="number" min="1" max="500" value="150" aria-label="返回条数" />
          <button id="btnSearch-mobile">搜索</button>
        </div>
        <p class="hint" style="margin-top:8px">默认从今日 8 点开始查询，已为窄屏做压缩展示。</p>
        <div id="searchSummary-mobile"></div>
        <div id="searchAggregated-mobile"></div>
        <div id="searchRaw-mobile"></div>
      </div>

      <div class="card">
        <div class="section-header">
          <h2>全部礼物流水</h2>
          <div class="row">
            <input id="allLimit-mobile" type="number" min="1" max="800" value="150" aria-label="返回条数" />
            <button id="btnLoadAll-mobile">刷新</button>
          </div>
        </div>
        <p class="hint">表格可左右滑动查看全部字段。</p>
        <div id="allOut-mobile"></div>
      </div>
    </div>

    <!-- 控制台：单独页面，专注管理操作 -->
    <div id="view-console" class="view">
      <div class="card console-card">
        <div class="section-header">
          <h2>控制台</h2>
          <span class="muted" id="consoleSummary">按条件筛选并快捷操作流水</span>
        </div>
        <div class="filter-grid">
          <label>开始时间<input id="consoleStart" type="datetime-local" aria-label="开始时间" /></label>
          <label>结束时间<input id="consoleEnd" type="datetime-local" aria-label="结束时间" /></label>
          <label>用户名（可选）<input id="consoleUname" placeholder="精确匹配" /></label>
          <label>礼物名（可选）<input id="consoleGift" placeholder="精确匹配" /></label>
          <label>大航海（可选）
            <select id="consoleGuardLevel" aria-label="大航海等级">
              <option value="">全部</option>
              <option value="3">舰长</option>
              <option value="2">提督</option>
              <option value="1">总督</option>
            </select>
          </label>
          <label>条数限制<input id="consoleLimit" type="number" min="1" max="1000" value="200" aria-label="返回条数" /></label>
          <label>记录 ID（用于单独操作）<input id="consoleRecordId" type="number" min="1" placeholder="记录 ID" aria-label="记录 ID" /></label>
        </div>
        <div class="filter-actions">
          <button id="btnConsoleFilter">筛选流水</button>
          <button id="btnConsoleReset" class="ghost-btn">重置时间</button>
          <button id="btnInspectRecord" class="ghost-btn">查看记录</button>
          <button id="btnDeleteRecord" style="background:linear-gradient(135deg,#f472b6,#ec4899);">删除记录</button>
        </div>
        <p class="hint" style="margin:8px 0;">下方列表支持直接操作，默认查看从今日 8 点至今的流水，可按需缩小时间范围。</p>
        <div id="consoleList"></div>
        <div id="consoleLog" class="console-log" aria-live="polite" style="margin-top:12px;"></div>
      </div>

      <div class="card console-card">
        <div class="section-header">
          <h2>感谢与定时弹幕配置</h2>
          <span class="muted">保存后会写入当前后端使用的 .env</span>
        </div>

        <div class="settings-grid">
          <div class="settings-block">
            <h4>感谢规则</h4>
            <div class="field inline">
              <label class="inline">感谢大航海<input type="checkbox" id="thankGuardToggle" /></label>
            </div>
            <div class="field">
              <div class="inline radios">
                <label class="inline">按数量<input type="radio" name="thankMode" value="count" id="thankModeCount" checked /></label>
                <label class="inline">按价值<input type="radio" name="thankMode" value="value" id="thankModeValue" /></label>
              </div>
              <p class="hint" style="margin:4px 0 0;">两种机制只能选一个：按数量会累积同一天的礼物；按价值使用单次流水总价阈值。</p>
            </div>

            <div id="countModeFields">
              <div class="field">
                <label>感谢的礼物名（逗号分隔）<input id="targetGiftsInput" placeholder="例如：人气票, 辣条" /></label>
              </div>
              <div class="field">
                <label>感谢的礼物 ID（逗号分隔）<input id="targetGiftIdsInput" placeholder="可选，数字" /></label>
              </div>
              <div class="field inline">
                <label class="inline">最低礼物数量<input id="targetMinNumInput" type="number" min="1" value="50" style="max-width:120px;" /></label>
                <label class="inline">单用户每日感谢次数<input id="dailyThanksLimitInput" type="number" min="0" value="0" style="max-width:140px;" /></label>
              </div>
            </div>

            <div id="valueModeFields" style="display:none;">
              <div class="field">
                <label>单次总价值阈值（单位：金瓜子）<input id="valueThresholdInput" type="number" min="0" value="0" /></label>
                <p class="hint">单次流水达到该金额就感谢；留空或 0 表示关闭。</p>
              </div>
            </div>
          </div>

          <div class="settings-block">
            <h4>感谢弹幕模板</h4>
            <div class="field">
              <label>汇总感谢
                <textarea id="summaryTemplateInput" placeholder="谢谢 {uname} 送的 {gifts}！太帅了！"></textarea>
              </label>
            </div>
            <div class="field">
              <label>单个礼物
                <textarea id="singleTemplateInput" placeholder="谢谢 {uname} 送的 {gift_name} x{num}！"></textarea>
              </label>
            </div>
            <div class="field">
              <label>大航海
                <textarea id="guardTemplateInput" placeholder="感谢{uname}的{guard_name}！！你最帅了！"></textarea>
              </label>
            </div>
            <p class="hint">支持占位符：{uname} / {gift_name} / {num} / {gifts} / {guard_name}</p>
          </div>

          <div class="settings-block">
            <h4>定时弹幕</h4>
            <div class="field inline" style="flex-wrap: wrap; gap: 12px;">
              <label class="inline">开启定时弹幕<input type="checkbox" id="announceEnabledToggle" /></label>
              <div class="inline radios" style="margin-left: 4px;">
                <label class="inline">按时间<input type="radio" name="announceMode" value="interval" id="announceModeInterval" checked /></label>
                <label class="inline">按弹幕数<input type="radio" name="announceMode" value="message_count" id="announceModeCount" /></label>
              </div>
              <span class="hint" style="margin:0 6px;">按弹幕数时，会在其他人发送的弹幕累计达到阈值后发送一条定时弹幕。</span>
              <label class="inline" id="announceIntervalField">间隔（秒）<input id="announceIntervalInput" type="number" min="30" value="300" style="max-width:120px;" /></label>
              <label class="inline" id="announceThresholdField" style="display:none;">触发阈值（条）<input id="announceThresholdInput" type="number" min="1" value="5" style="max-width:120px;" /></label>
            </div>
            <div class="field">
              <label>定时发送内容
                <textarea id="announceMessageInput" placeholder="每行一条，自动轮播"></textarea>
              </label>
              <div class="row" style="margin-top:6px; gap:8px; align-items: center; flex-wrap: wrap;">
                <button type="button" id="announceCleanupBtn" class="ghost-btn" style="padding:8px 10px;">整理换行</button>
                <span class="hint" id="announcePreviewHint">一行一条；支持逗号或换行分隔，点击“整理换行”自动拆分并去除空行。</span>
              </div>
              <div id="announcePreview" class="row" style="margin-top:8px; gap:6px; flex-wrap: wrap;"></div>
            </div>
            <div class="field inline">
              <label class="inline">未开播时不发<input type="checkbox" id="announceSkipOfflineToggle" checked /></label>
            </div>
            <p class="hint">需要小号登录态才能发送，默认 5 分钟一次；多行内容会轮播发送。</p>
          </div>

          <div class="settings-block">
            <h4>心动盲盒盈亏查询</h4>
            <div class="field inline" style="flex-wrap: wrap; gap: 12px;">
              <label class="inline">开启查询<input type="checkbox" id="blindBoxEnabledToggle" /></label>
              <label class="inline">回复到弹幕<input type="checkbox" id="blindBoxSendToggle" checked /></label>
            </div>
            <div class="field">
              <label>触发短句（逗号或换行分隔）<input id="blindBoxTriggersInput" placeholder="例如：查询盲盒, 查盲盒" /></label>
            </div>
            <div class="field inline">
              <label class="inline">基础礼物名<input id="blindBoxBaseGiftInput" placeholder="心动盲盒" /></label>
              <label class="inline">开出礼物名（逗号分隔）<input id="blindBoxRewardsInput" placeholder="电影票,棉花糖,..." /></label>
            </div>
            <div class="field">
              <label>盈亏回复模板
                <textarea id="blindBoxTemplateInput" placeholder="{uname} 心动盲盒投入¥{base_cost_yuan}，产出¥{reward_value_yuan}，盈亏¥{profit_yuan}"></textarea>
              </label>
              <p class="hint">占位符：{uname} / {uid} / {base_cost} / {reward_value} / {profit} / {base_cost_yuan} / {reward_value_yuan} / {profit_yuan} / {profit_sign} / {base_gift}</p>
            </div>
            <p class="hint">收到触发短句后会查询该用户的盲盒记录，基础礼物不会入库，开出的礼物会入库并按每个 ¥15 计价后计算盈亏，同时在控制台打印日志。</p>
          </div>
        </div>

        <div class="row" style="justify-content: flex-end;">
          <button id="btnReloadSettings" class="ghost-btn">重载 .env</button>
          <button id="btnSaveSettings">保存到 .env</button>
        </div>
        <p class="hint" id="settingsStatus"></p>
      </div>
    </div>

    <!-- 平板版：两列布局，无房间礼物清单 -->
    <div id="view-tablet" class="view tablet-layout">
      <div class="tablet-grid">
        <div class="card">
          <div class="section-header">
            <h2>平板搜索</h2>
            <span class="muted">保持信息密度</span>
          </div>
          <div class="row">
            <input id="uname-tablet" placeholder="用户名（精确匹配）" />
            <input id="gift-tablet" placeholder="礼物名（可选）" />
            <select id="guardLevel-tablet" aria-label="大航海等级">
              <option value="">全部大航海</option>
              <option value="3">舰长</option>
              <option value="2">提督</option>
              <option value="1">总督</option>
            </select>
            <input id="startTime-tablet" type="datetime-local" aria-label="开始时间" />
            <input id="limit-tablet" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
            <button id="btnSearch-tablet">搜索</button>
          </div>
          <p class="hint" style="margin-top:8px">保留桌面级的汇总表格，去除房间礼物清单，方便分屏。</p>
          <div id="searchSummary-tablet"></div>
          <div id="searchAggregated-tablet"></div>
          <div id="searchRaw-tablet"></div>
        </div>

        <div class="card">
          <div class="section-header">
            <h2>最新流水</h2>
            <div class="row">
              <input id="allLimit-tablet" type="number" min="1" max="1000" value="200" aria-label="返回条数" />
              <button id="btnLoadAll-tablet">刷新</button>
            </div>
          </div>
          <p class="hint">适配横屏 / 竖屏，支持左右滑动。</p>
          <div id="allOut-tablet"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const TARGET_TIMEZONE = "Asia/Shanghai";

const getTargetDateInfo = (date = new Date()) => {
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: TARGET_TIMEZONE,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    weekday: "short",
    timeZoneName: "shortOffset",
  }).formatToParts(date);

  const map = Object.fromEntries(parts.map((p) => [p.type, p.value]));
  const weekdayIndex = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 }[map.weekday] ?? 0;

  const tzName = map.timeZoneName || "GMT";
  const match = tzName.match(/GMT([+-]\d{1,2})(?::?(\d{2}))?/);
  const sign = match?.[1]?.startsWith("-") ? -1 : 1;
  const hours = Number(match?.[1]?.replace(/[+-]/, "") || 0);
  const minutes = Number(match?.[2] || 0);
  const offsetMinutes = sign * (hours * 60 + minutes);

  return {
    year: Number(map.year),
    month: Number(map.month),
    day: Number(map.day),
    weekday: weekdayIndex,
    offsetMinutes,
  };
};

const buildTargetDate = (year, month, day, offsetMinutes) => {
  const utcMillis = Date.UTC(year, month - 1, day);
  return new Date(utcMillis - offsetMinutes * 60 * 1000);
};

const fmtTime = (ts) => {
  if (!ts) return "-";
  const d = new Date(ts * 1000);
  return d.toLocaleString("zh-CN", { timeZone: TARGET_TIMEZONE });
};

const fmtNumber = (n) => new Intl.NumberFormat("zh-CN").format(n);
const coinsToYuan = (coins) => (Number(coins) || 0) / 1000;
const fmtCurrency = (coins) =>
  new Intl.NumberFormat("zh-CN", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(coinsToYuan(coins));

const logConsole = (message, type = "info") => {
  const log = document.getElementById("consoleLog");
  if (!log) return;
  const line = document.createElement("div");
  line.className = `line ${type}`;
  line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  log.prepend(line);
};

const setSettingsStatus = (message, tone = "info") => {
  const status = document.getElementById("settingsStatus");
  if (status) {
    status.textContent = message || "";
    status.style.color = tone === "error" ? "#f472b6" : "var(--muted)";
  }
  logConsole(message, tone);
};

const getTargetNow = (offsetMinutes) => {
  const now = new Date();
  const utcMillis = now.getTime() + now.getTimezoneOffset() * 60 * 1000;
  return new Date(utcMillis + offsetMinutes * 60 * 1000);
};

const defaultStartDate = () => {
  const info = getTargetDateInfo();
  const eightAm = buildTargetDate(info.year, info.month, info.day, info.offsetMinutes);
  eightAm.setUTCHours(eightAm.getUTCHours() + 8);
  const nowInTarget = getTargetNow(info.offsetMinutes);
  if (eightAm > nowInTarget) {
    eightAm.setUTCDate(eightAm.getUTCDate() - 1);
  }
  return eightAm;
};

const nowDateTime = () => new Date();

const getRangeTimestamps = (rangeKey) => {
  const { year, month, day, weekday, offsetMinutes } = getTargetDateInfo();
  const targetNow = getTargetNow(offsetMinutes);
  let start = buildTargetDate(year, month, day, offsetMinutes);

  if (rangeKey === "week") {
    const diff = weekday === 0 ? 6 : weekday - 1; // Monday as start of week
    start = new Date(start.getTime() - diff * 24 * 60 * 60 * 1000);
  } else if (rangeKey === "month") {
    start = buildTargetDate(year, month, 1, offsetMinutes);
  } else if (rangeKey !== "today") {
    return { start_ts: undefined, end_ts: undefined };
  }

  return { start_ts: Math.floor(start.getTime() / 1000), end_ts: Math.floor(targetNow.getTime() / 1000) };
};

const buildUrl = (path, params) => {
  const searchParams = params instanceof URLSearchParams ? params : new URLSearchParams(params || {});
  const qs = searchParams.toString();
  return qs ? `${path}?${qs}` : path;
};

const renderTable = (container, rows, columns, emptyText = "暂无数据") => {
  if (!rows.length) {
    container.innerHTML = `<div class="empty">${emptyText}</div>`;
    return;
  }
  const header = columns.map((c) => `<th>${c.label}</th>`).join("");
  const body = rows
    .map((row) =>
      `<tr>${columns
        .map((c) => `<td class="${c.className || ''}">${c.render ? c.render(row[c.key], row) : row[c.key]}</td>`)
        .join("")}</tr>`
    )
    .join("");
  container.innerHTML = `<div class="table-scroll"><table><thead><tr>${header}</tr></thead><tbody>${body}</tbody></table></div>`;
};

const groupByGift = (records) => {
  const map = new Map();
  records.forEach((r) => {
    const key = r.gift_name || "(未知礼物)";
    const current = map.get(key) || { gift_name: key, total_num: 0, total_price: 0, latest_ts: 0, users: new Set() };
    current.total_num += Number(r.num) || 0;
    current.total_price += Number(r.total_price) || 0;
    current.latest_ts = Math.max(current.latest_ts, r.ts || 0);
    if (r.uname) current.users.add(r.uname);
    map.set(key, current);
  });
  return Array.from(map.values())
    .map((v) => ({ ...v, user_count: v.users.size || 0 }))
    .sort((a, b) => b.total_num - a.total_num || b.latest_ts - a.latest_ts);
};

const groupByUser = (records) => {
  const map = new Map();
  records.forEach((r) => {
    const key = r.uname || `UID-${r.uid}`;
    const current = map.get(key) || { uname: key, total_num: 0, total_price: 0, latest_ts: 0, gifts: new Set() };
    current.total_num += Number(r.num) || 0;
    current.total_price += Number(r.total_price) || 0;
    current.latest_ts = Math.max(current.latest_ts, r.ts || 0);
    if (r.gift_name) current.gifts.add(r.gift_name);
    map.set(key, current);
  });
  return Array.from(map.values())
    .map((v) => ({ ...v, gift_count: v.gifts.size || 0 }))
    .sort((a, b) => b.total_num - a.total_num || b.latest_ts - a.latest_ts);
};

let activeView = "desktop";
let activeRange = "today";

const viewConfigs = {
  desktop: {
    root: document.getElementById("view-desktop"),
    search: {
      button: "btnSearch-desktop",
      inputs: {
        uname: "uname-desktop",
        gift: "gift-desktop",
        guardLevel: "guardLevel-desktop",
        start: "startTime-desktop",
        limit: "limit-desktop",
      },
      outputs: { summary: "searchSummary-desktop", aggregated: "searchAggregated-desktop", raw: "searchRaw-desktop" },
    },
    latest: { button: "btnLoadAll-desktop", limit: "allLimit-desktop", output: "allOut-desktop" },
    roomGifts: { button: "btnLoadRoomGifts", output: "roomGiftsOut" },
  },
  mobile: {
    root: document.getElementById("view-mobile"),
    search: {
      button: "btnSearch-mobile",
      inputs: {
        uname: "uname-mobile",
        gift: "gift-mobile",
        guardLevel: "guardLevel-mobile",
        start: "startTime-mobile",
        limit: "limit-mobile",
      },
      outputs: { summary: "searchSummary-mobile", aggregated: "searchAggregated-mobile", raw: "searchRaw-mobile" },
    },
    latest: { button: "btnLoadAll-mobile", limit: "allLimit-mobile", output: "allOut-mobile" },
  },
  tablet: {
    root: document.getElementById("view-tablet"),
    search: {
      button: "btnSearch-tablet",
      inputs: {
        uname: "uname-tablet",
        gift: "gift-tablet",
        guardLevel: "guardLevel-tablet",
        start: "startTime-tablet",
        limit: "limit-tablet",
      },
      outputs: { summary: "searchSummary-tablet", aggregated: "searchAggregated-tablet", raw: "searchRaw-tablet" },
    },
    latest: { button: "btnLoadAll-tablet", limit: "allLimit-tablet", output: "allOut-tablet" },
  },
  console: {
    root: document.getElementById("view-console"),
  },
};

const viewState = Object.fromEntries(
  Object.keys(viewConfigs).map((k) => [k, { initialized: false, loadedAll: false, roomLoaded: false, settingsLoaded: false }])
);

const renderSearch = (records, targets) => {
  const summary = document.getElementById(targets.summary);
  const aggregated = document.getElementById(targets.aggregated);
  const raw = document.getElementById(targets.raw);

  const totalNum = records.reduce((acc, r) => acc + (Number(r.num) || 0), 0);
  const totalPrice = records.reduce((acc, r) => acc + (Number(r.total_price) || 0), 0);
  const latestTs = Math.max(0, ...records.map((r) => r.ts || 0));

  summary.innerHTML = `
    <div class="flex-between" style="margin:12px 0 6px;">
      <div class="badge">记录数：${fmtNumber(records.length)}</div>
      <div class="badge">总数量：${fmtNumber(totalNum)}</div>
      <div class="badge">总金额（元）：${fmtCurrency(totalPrice)}</div>
      <div class="badge">最新时间：${latestTs ? fmtTime(latestTs) : "-"}</div>
    </div>
  `;

  const byGift = groupByGift(records);
  const byUser = groupByUser(records);

  aggregated.innerHTML = `<h3 style="margin-top:8px;">汇总视图</h3>`;
  const giftContainer = document.createElement("div");
  const userContainer = document.createElement("div");
  aggregated.appendChild(giftContainer);
  aggregated.appendChild(userContainer);

  renderTable(
    giftContainer,
    byGift,
    [
      { key: "gift_name", label: "礼物" },
      { key: "total_num", label: "数量合计", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
      { key: "user_count", label: "涉及用户", className: "number", render: (v) => fmtNumber(v) },
      { key: "latest_ts", label: "最新时间", render: (v) => fmtTime(v) },
    ],
    "没有找到相关礼物"
  );

  userContainer.style.marginTop = "12px";
  renderTable(
    userContainer,
    byUser,
    [
      { key: "uname", label: "用户" },
      { key: "total_num", label: "礼物数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "合计金额（元）", className: "number", render: (v) => fmtCurrency(v) },
      { key: "gift_count", label: "礼物种类", className: "number", render: (v) => fmtNumber(v) },
      { key: "latest_ts", label: "最新时间", render: (v) => fmtTime(v) },
    ],
    "没有匹配的用户记录"
  );

  raw.innerHTML = `<h3 style="margin-top:12px;">原始记录</h3>`;
  const rawContainer = document.createElement("div");
  raw.appendChild(rawContainer);
  renderTable(
    rawContainer,
    records,
    [
      { key: "id", label: "ID", className: "number" },
      { key: "ts", label: "时间", render: (v) => fmtTime(v) },
      { key: "uname", label: "用户" },
      { key: "gift_name", label: "礼物" },
      { key: "num", label: "数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
    ],
    "暂无记录"
  );
};

const renderConsoleRecords = (records) => {
  const container = document.getElementById("consoleList");
  renderTable(
    container,
    records,
    [
      { key: "id", label: "ID", className: "number" },
      { key: "ts", label: "时间", render: (v) => fmtTime(v) },
      { key: "uname", label: "用户" },
      { key: "gift_name", label: "礼物" },
      { key: "num", label: "数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
      {
        key: "actions",
        label: "操作",
        render: (_, row) =>
          `<div class="row" style="gap:6px;">` +
          `<button class="ghost-btn" data-inspect-id="${row.id}">查看</button>` +
          `<button class="ghost-btn" data-delete-id="${row.id}" style="border-color:#f472b6;color:#f472b6;">删除</button>` +
          `</div>`,
      },
    ],
    "暂无流水（可调整筛选条件）"
  );

  container.querySelectorAll("[data-inspect-id]").forEach((btn) => {
    btn.addEventListener("click", () => inspectRecord(Number(btn.dataset.inspectId)));
  });
  container.querySelectorAll("[data-delete-id]").forEach((btn) => {
    btn.addEventListener("click", () => deleteRecord(Number(btn.dataset.deleteId)));
  });

  updateConsoleSummary(records);
};

const getInputValue = (id) => document.getElementById(id)?.value.trim();

const setDefaultStartTime = (id) => {
  const el = document.getElementById(id);
  if (!el) return;
  const start = defaultStartDate();
  el.value = start.toISOString().slice(0, 16);
};

const setNowTime = (id) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.value = nowDateTime().toISOString().slice(0, 16);
};

const getDateInputSeconds = (id) => {
  const el = document.getElementById(id);
  if (!el || !el.value) return undefined;
  const parsed = Math.floor(new Date(el.value).getTime() / 1000);
  return Number.isNaN(parsed) ? undefined : parsed;
};

const updateTotalFlow = (data) => {
  const valueEl = document.getElementById("totalFlowValue");
  const metaEl = document.getElementById("totalFlowMeta");
  if (!valueEl || !metaEl) return;

  let totalPrice = 0;
  let totalNum = 0;
  let recordCount = 0;

  if (Array.isArray(data)) {
    recordCount = data.length;
    totalPrice = data.reduce((acc, r) => acc + (Number(r.total_price) || 0), 0);
    totalNum = data.reduce((acc, r) => acc + (Number(r.num) || 0), 0);
  } else if (data) {
    recordCount = Number(data.record_count ?? data.length ?? 0) || 0;
    totalPrice = Number(data.total_price ?? 0) || 0;
    totalNum = Number(data.total_num ?? 0) || 0;
  }

  valueEl.textContent = `¥${fmtCurrency(totalPrice)}`;
  metaEl.textContent = `记录：${fmtNumber(recordCount)} ｜ 数量：${fmtNumber(totalNum)}`;
};

const updateGuardFlow = (guardStats) => {
  const valueEl = document.getElementById("guardFlowValue");
  const metaEl = document.getElementById("guardFlowMeta");
  if (!valueEl || !metaEl) return;

  const captain = Number(guardStats?.captain ?? 0) || 0;
  const admiral = Number(guardStats?.admiral ?? 0) || 0;
  const governor = Number(guardStats?.governor ?? 0) || 0;
  const total = captain + admiral + governor;

  valueEl.textContent = `总计 ${fmtNumber(total)} 单大航海`;
  metaEl.textContent = `舰长：${fmtNumber(captain)} ｜ 提督：${fmtNumber(admiral)} ｜ 总督：${fmtNumber(governor)}`;
};

const refreshSummary = async () => {
  const params = new URLSearchParams();
  const { start_ts, end_ts } = getRangeTimestamps(activeRange);
  if (start_ts !== undefined) params.set("start_ts", String(start_ts));
  if (end_ts !== undefined) params.set("end_ts", String(end_ts));

  try {
    const resp = await fetch(buildUrl("/api/summary", params));
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    updateTotalFlow(data);
    updateGuardFlow(data.guard);
  } catch (err) {
    console.error("加载汇总数据失败", err);
  }
};

const updateConsoleSummary = (records) => {
  const el = document.getElementById("consoleSummary");
  if (!el) return;
  if (!records.length) {
    el.textContent = "未找到流水，请调整时间或过滤条件";
    return;
  }
  const totalPrice = records.reduce((acc, r) => acc + (Number(r.total_price) || 0), 0);
  const totalNum = records.reduce((acc, r) => acc + (Number(r.num) || 0), 0);
  el.textContent = `筛选到 ${fmtNumber(records.length)} 条，数量 ${fmtNumber(totalNum)}，金额 ¥${fmtCurrency(totalPrice)}`;
};

  const updateThankModeVisibility = (mode) => {
    const countFields = document.getElementById("countModeFields");
    const valueFields = document.getElementById("valueModeFields");
    if (countFields) countFields.style.display = mode === "value" ? "none" : "block";
    if (valueFields) valueFields.style.display = mode === "value" ? "block" : "none";
  };

  const updateAnnounceModeVisibility = (mode) => {
    const intervalField = document.getElementById("announceIntervalField");
    const thresholdField = document.getElementById("announceThresholdField");
    const intervalInput = document.getElementById("announceIntervalInput");
    const thresholdInput = document.getElementById("announceThresholdInput");

    const isCountMode = mode === "message_count";

    if (intervalField) intervalField.style.display = isCountMode ? "none" : "inline-flex";
    if (thresholdField) thresholdField.style.display = isCountMode ? "inline-flex" : "none";
    if (intervalInput) intervalInput.disabled = isCountMode;
    if (thresholdInput) thresholdInput.disabled = !isCountMode;
  };

const parseAnnouncements = (value) =>
  (value || "")
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter(Boolean);

const tidyAnnouncements = (value) =>
  (value || "")
    .replace(/，/g, ",")
    .split(/[\n,]/)
    .map((line) => line.trim())
    .filter(Boolean);

const normalizeAnnouncements = (value) => tidyAnnouncements(value).join("\n");

const updateAnnouncePreview = (rawValue) => {
  const preview = document.getElementById("announcePreview");
  const hint = document.getElementById("announcePreviewHint");
  if (!preview || !hint) return;

  const items = parseAnnouncements(rawValue);
  preview.innerHTML = "";

  if (!items.length) {
    preview.innerHTML = '<span class="hint">暂无内容，填写后会按顺序轮播。</span>';
    hint.textContent = "一行一条；支持逗号或换行分隔，点击“整理换行”自动拆分并去除空行。";
    return;
  }

  items.forEach((msg, idx) => {
    const pill = document.createElement("span");
    pill.className = "badge";
    pill.textContent = `${idx + 1}. ${msg}`;
    preview.appendChild(pill);
  });

  hint.textContent = `共 ${items.length} 条，按顺序轮播；点击“整理换行”可快速分行。`;
};

const applySettingsToForm = (settings) => {
  document.getElementById("thankGuardToggle").checked = !!settings.thank_guard;

  const mode = settings.thank_mode === "value" ? "value" : "count";
  const modeInput = document.getElementById(mode === "value" ? "thankModeValue" : "thankModeCount");
  if (modeInput) modeInput.checked = true;
  updateThankModeVisibility(mode);

  const announceMode = settings.announce_mode === "message_count" ? "message_count" : "interval";
  const announceModeInput = document.getElementById(
    announceMode === "message_count" ? "announceModeCount" : "announceModeInterval",
  );
  if (announceModeInput) announceModeInput.checked = true;
  updateAnnounceModeVisibility(announceMode);

  document.getElementById("targetGiftsInput").value = (settings.target_gifts || []).join(", ");
  document.getElementById("targetGiftIdsInput").value = (settings.target_gift_ids || []).join(", ");
  document.getElementById("targetMinNumInput").value = settings.target_min_num ?? 50;
  document.getElementById("dailyThanksLimitInput").value = settings.thank_per_user_daily_limit ?? 0;
  document.getElementById("valueThresholdInput").value = settings.thank_value_threshold ?? 0;

  document.getElementById("summaryTemplateInput").value = settings.thank_templates?.summary || "";
  document.getElementById("singleTemplateInput").value = settings.thank_templates?.single || "";
  document.getElementById("guardTemplateInput").value = settings.thank_templates?.guard || "";

  document.getElementById("announceEnabledToggle").checked = !!settings.announce_enabled;
  document.getElementById("announceIntervalInput").value = settings.announce_interval_sec ?? 300;
  document.getElementById("announceThresholdInput").value = settings.announce_danmaku_threshold ?? 5;
  const announceText = settings.announce_message || "";
  document.getElementById("announceMessageInput").value = announceText;
  updateAnnouncePreview(announceText);
  document.getElementById("announceSkipOfflineToggle").checked = !!settings.announce_skip_offline;

  document.getElementById("blindBoxEnabledToggle").checked = !!settings.blind_box_enabled;
  document.getElementById("blindBoxSendToggle").checked = !!settings.blind_box_send_danmaku;
  document.getElementById("blindBoxTriggersInput").value = (settings.blind_box_triggers || []).join(", ");
  document.getElementById("blindBoxBaseGiftInput").value = settings.blind_box_base_gift || "";
  document.getElementById("blindBoxRewardsInput").value = (settings.blind_box_rewards || []).join(", ");
  document.getElementById("blindBoxTemplateInput").value = settings.blind_box_template || "";
};

const collectSettingsFromForm = () => {
  const thankMode = document.querySelector('input[name="thankMode"]:checked')?.value || "count";
  const announceMode = document.querySelector('input[name="announceMode"]:checked')?.value || "interval";
  const parseCsv = (value) =>
    (value || "")
      .replace(/，/g, ",")
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean);

  const parsePhrases = (value) =>
    (value || "")
      .replace(/，/g, ",")
      .split(/[\n,]/)
      .map((s) => s.trim())
      .filter(Boolean);

  const targetGifts = parseCsv(document.getElementById("targetGiftsInput").value);
  const targetGiftIds = parseCsv(document.getElementById("targetGiftIdsInput").value)
    .map((v) => Number(v))
    .filter((n) => !Number.isNaN(n));

  const toInt = (value, fallback = 0) => {
    const n = parseInt(value || "", 10);
    return Number.isNaN(n) ? fallback : n;
  };

  const normalizeMultiline = (value) =>
    (value || "")
      .split(/\r?\n/)
      .map((line) => line.trim())
      .filter(Boolean)
      .join("\n");

  return {
    thank_guard: document.getElementById("thankGuardToggle").checked,
    thank_mode: thankMode,
    target_gifts: targetGifts,
    target_gift_ids: targetGiftIds,
    target_min_num: toInt(document.getElementById("targetMinNumInput").value, 1),
    thank_per_user_daily_limit: toInt(document.getElementById("dailyThanksLimitInput").value, 0),
    thank_value_threshold: toInt(document.getElementById("valueThresholdInput").value, 0),
    thank_templates: {
      summary: document.getElementById("summaryTemplateInput").value,
      single: document.getElementById("singleTemplateInput").value,
      guard: document.getElementById("guardTemplateInput").value,
    },
    announce_enabled: document.getElementById("announceEnabledToggle").checked,
    announce_interval_sec: Math.max(toInt(document.getElementById("announceIntervalInput").value, 300), 30),
    announce_message: normalizeAnnouncements(document.getElementById("announceMessageInput").value),
    announce_skip_offline: document.getElementById("announceSkipOfflineToggle").checked,
    announce_mode: announceMode,
    announce_danmaku_threshold: Math.max(toInt(document.getElementById("announceThresholdInput").value, 5), 1),
    blind_box_enabled: document.getElementById("blindBoxEnabledToggle").checked,
    blind_box_triggers: parsePhrases(document.getElementById("blindBoxTriggersInput").value),
    blind_box_base_gift: document.getElementById("blindBoxBaseGiftInput").value,
    blind_box_rewards: parsePhrases(document.getElementById("blindBoxRewardsInput").value),
    blind_box_template: normalizeMultiline(document.getElementById("blindBoxTemplateInput").value),
    blind_box_send_danmaku: document.getElementById("blindBoxSendToggle").checked,
  };
};

const loadSettings = async () => {
  try {
    const resp = await fetch(buildUrl("/api/settings"));
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    applySettingsToForm(data);
    viewState.console.settingsLoaded = true;
    setSettingsStatus("已加载当前配置", "success");
  } catch (err) {
    setSettingsStatus(`加载配置失败：${err.message || err}`, "error");
  }
};

const saveSettings = async () => {
  const payload = collectSettingsFromForm();
  try {
    const resp = await fetch(buildUrl("/api/settings"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    applySettingsToForm(data);
    setSettingsStatus("保存成功，已写入 .env", "success");
    viewState.console.settingsLoaded = true;
  } catch (err) {
    setSettingsStatus(`保存失败：${err.message || err}`, "error");
  }
};

const getConsoleRecordId = () => {
  const input = document.getElementById("consoleRecordId");
  if (!input) return null;
  const val = Number(input.value.trim());
  if (!val || val < 1) {
    logConsole("请输入有效的记录 ID", "error");
    return null;
  }
  return val;
};

const inspectRecord = async (overrideId) => {
  const id = overrideId || getConsoleRecordId();
  if (!id) return;
  try {
    const resp = await fetch(buildUrl(`/api/gifts/${id}`));
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    logConsole(
      `记录 ${id}: 用户 ${data.uname || "(未知)"} 送出 ${data.gift_name || "-"} x${fmtNumber(data.num)}，金额 ¥${fmtCurrency(
        data.total_price
      )}，时间 ${fmtTime(data.ts)}`,
      "info"
    );
  } catch (err) {
    logConsole(`查看失败：${err.message || err}`, "error");
  }
};

const deleteRecord = async (overrideId) => {
  const id = overrideId || getConsoleRecordId();
  if (!id) return;
  const confirmed = confirm(`确认删除记录 ${id} 吗？此操作不可恢复。`);
  if (!confirmed) return;
  try {
    const resp = await fetch(buildUrl(`/api/gifts/${id}`), { method: "DELETE" });
    if (!resp.ok) {
      const errorText = await resp.text();
      throw new Error(errorText || `HTTP ${resp.status}`);
    }
    logConsole(`已删除记录 ${id}，正在刷新列表...`, "success");
    if (activeView === "console") {
      loadConsoleRecords();
    } else {
      loadAll(activeView);
    }
  } catch (err) {
    logConsole(`删除失败：${err.message || err}`, "error");
  }
};

async function search(viewKey) {
  const cfg = viewConfigs[viewKey];
  const inputs = cfg.search.inputs;
  const uname = getInputValue(inputs.uname);
  const gift = getInputValue(inputs.gift);
  const guardLevel = parseInt(getInputValue(inputs.guardLevel) || "", 10);
  const limit = parseInt(document.getElementById(inputs.limit)?.value || "0", 10) || 200;
  const startInput = document.getElementById(inputs.start);
  const startValue = startInput?.value;
  const parsedStart = startValue ? Math.floor(new Date(startValue).getTime() / 1000) : NaN;
  const start_ts = Number.isNaN(parsedStart) ? undefined : parsedStart;

  if (!uname) {
    alert("请输入用户名");
    return;
  }

  const params = new URLSearchParams({ uname, limit: String(limit) });
  if (gift) params.set("gift_name", gift);
  if (guardLevel) params.set("guard_level", String(guardLevel));
  if (start_ts) params.set("start_ts", String(start_ts));

  const resp = await fetch(buildUrl("/api/search", params));
  const data = await resp.json();
  renderSearch(data, cfg.search.outputs);
}

const buildConsoleParams = () => {
  const params = new URLSearchParams();
  const limit = parseInt(document.getElementById("consoleLimit")?.value || "0", 10) || 200;
  params.set("limit", String(limit));

  const start = getDateInputSeconds("consoleStart");
  const end = getDateInputSeconds("consoleEnd");
  const uname = getInputValue("consoleUname");
  const gift = getInputValue("consoleGift");
  const guardLevel = parseInt(getInputValue("consoleGuardLevel") || "", 10);

  if (start) params.set("start_ts", String(start));
  if (end) params.set("end_ts", String(end));
  if (uname) params.set("uname", uname);
  if (gift) params.set("gift_name", gift);
  if (guardLevel) params.set("guard_level", String(guardLevel));

  return params;
};

const loadConsoleRecords = async () => {
  logConsole("正在加载筛选后的流水...", "info");
  const params = buildConsoleParams();
  const resp = await fetch(buildUrl("/api/gifts", params));
  const data = await resp.json();
  renderConsoleRecords(data);
  viewState.console.loadedAll = true;
};

const resetConsoleFilters = () => {
  setDefaultStartTime("consoleStart");
  setNowTime("consoleEnd");
  const optionalIds = ["consoleUname", "consoleGift", "consoleRecordId", "consoleGuardLevel"];
  optionalIds.forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  document.getElementById("consoleLimit").value = "200";
};

async function loadAll(viewKey) {
  const cfg = viewConfigs[viewKey];
  const limitInput = document.getElementById(cfg.latest.limit);
  const limit = parseInt(limitInput?.value || "0", 10) || 200;
  const resp = await fetch(buildUrl("/api/gifts", { limit }));
  const data = await resp.json();
  const container = document.getElementById(cfg.latest.output);
  renderTable(
    container,
    data,
    [
      { key: "id", label: "ID", className: "number" },
      { key: "ts", label: "时间", render: (v) => fmtTime(v) },
      { key: "uname", label: "用户" },
      { key: "gift_name", label: "礼物" },
      { key: "num", label: "数量", className: "number", render: (v) => fmtNumber(v) },
      { key: "total_price", label: "总价（元）", className: "number", render: (v) => fmtCurrency(v) },
    ],
    "暂无礼物流水"
  );
  viewState[viewKey].loadedAll = true;
}

async function loadRoomGiftList() {
  const out = document.getElementById("roomGiftsOut");
  out.innerHTML = "<div class='muted'>加载中...</div>";
  try {
    const resp = await fetch(buildUrl("/api/room_gift_list"));
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    renderTable(
      out,
      data,
      [
        { key: "gift_id", label: "礼物 ID", className: "number" },
        { key: "name", label: "礼物名" },
        { key: "price", label: "价格", className: "number", render: (v) => `${fmtNumber(v)} 金瓜子` },
        { key: "coin_type", label: "币种" },
        { key: "gift_type", label: "类型" },
      ],
      "暂无礼物信息"
    );
    viewState.desktop.roomLoaded = true;
  } catch (err) {
    out.innerHTML = `<div class="empty">加载失败：${err}</div>`;
  }
}

const initView = (viewKey) => {
  const cfg = viewConfigs[viewKey];
  if (viewKey === "console") {
    resetConsoleFilters();
    document.getElementById("btnConsoleFilter")?.addEventListener("click", loadConsoleRecords);
    document.getElementById("btnConsoleReset")?.addEventListener("click", () => {
      resetConsoleFilters();
      loadConsoleRecords();
    });
    document.getElementById("btnInspectRecord")?.addEventListener("click", () => inspectRecord());
    document.getElementById("btnDeleteRecord")?.addEventListener("click", () => deleteRecord());
    document.getElementById("thankModeCount")?.addEventListener("change", () => updateThankModeVisibility("count"));
    document.getElementById("thankModeValue")?.addEventListener("change", () => updateThankModeVisibility("value"));
    document.getElementById("announceModeInterval")?.addEventListener("change", () => updateAnnounceModeVisibility("interval"));
    document.getElementById("announceModeCount")?.addEventListener("change", () => updateAnnounceModeVisibility("message_count"));
    document.getElementById("btnReloadSettings")?.addEventListener("click", loadSettings);
    document.getElementById("btnSaveSettings")?.addEventListener("click", saveSettings);
    document.getElementById("announceMessageInput")?.addEventListener("input", (ev) => {
      updateAnnouncePreview(ev.target.value);
    });
    document.getElementById("announceCleanupBtn")?.addEventListener("click", () => {
      const input = document.getElementById("announceMessageInput");
      if (!input) return;
      input.value = normalizeAnnouncements(input.value);
      updateAnnouncePreview(input.value);
    });
    loadSettings();
    logConsole("控制台已就绪，可筛选或直接输入记录 ID 操作。", "info");
  } else {
    if (cfg.search) {
      setDefaultStartTime(cfg.search.inputs.start);
      document.getElementById(cfg.search.button)?.addEventListener("click", () => search(viewKey));
    }
    if (cfg.latest) {
      document.getElementById(cfg.latest.button)?.addEventListener("click", () => loadAll(viewKey));
    }
    if (cfg.roomGifts) {
      document.getElementById(cfg.roomGifts.button)?.addEventListener("click", loadRoomGiftList);
    }
  }
  viewState[viewKey].initialized = true;
};

const switchView = (target) => {
  Object.entries(viewConfigs).forEach(([key, cfg]) => {
    cfg.root.classList.toggle("active", key === target);
  });
  document.querySelectorAll("[data-view-target]").forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.viewTarget === target);
  });

  activeView = target;
  const cfg = viewConfigs[target];

  if (!viewState[target].initialized) {
    initView(target);
  }
  if (cfg.latest && !viewState[target].loadedAll) {
    loadAll(target);
  }
  if (target === "desktop" && !viewState.desktop.roomLoaded) {
    loadRoomGiftList();
  }
  if (target === "console") {
    if (!viewState.console.settingsLoaded) {
      loadSettings();
    }
    if (!viewState.console.loadedAll) {
      loadConsoleRecords();
    }
  }
};

document.querySelectorAll("[data-view-target]").forEach((btn) => {
  btn.addEventListener("click", () => switchView(btn.dataset.viewTarget));
});

document.querySelectorAll("[data-range]").forEach((btn) => {
  btn.addEventListener("click", () => {
    const targetRange = btn.dataset.range;
    if (!targetRange) return;
    activeRange = targetRange;
    document
      .querySelectorAll("[data-range]")
      .forEach((item) => item.classList.toggle("active", item.dataset.range === activeRange));
    refreshSummary();
  });
});

initView("desktop");
switchView("desktop");
refreshSummary();
</script>
</body>
</html>
